pipeline {
    agent any

    environment {
        AWS_REGION       = "eu-central-1"
        AWS_ACCOUNT_ID   = "123456789012" 
        ECR_REGISTRY     = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        IMAGE_NAME       = "microservice-app"
        IMAGE_TAG        = "v${env.BUILD_ID}"
        FULL_IMAGE_URI   = "${ECR_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
        EKS_CLUSTER_NAME = "devsecops-cluster"
    }

    stages {
        stage('üßπ Clean & Checkout') {
            steps {
                cleanWs()
                checkout scm
                sh "chmod +x ci/scripts/*.sh"
            }
        }

        stage('üõ°Ô∏è IaC Compliance (Terraform)') {
            parallel {
                stage('TF Validate') { steps { sh "bash ci/scripts/terraform_validate.sh" } }
                stage('TFSec Scan') { steps { sh "bash ci/scripts/scan_tfsec.sh || true" } }
                stage('Checkov Scan') { steps { sh "bash ci/scripts/scan_checkov.sh || true" } }
            }
        }

        stage('üì¶ Docker Build & Security') {
            steps {
                script {
                    sh "bash ci/scripts/docker_build_push_ecr.sh ${FULL_IMAGE_URI}"
                    sh "bash ci/scripts/scan_trivy.sh ${FULL_IMAGE_URI}"
                }
            }
        }

        stage('üö¢ Push to Amazon ECR') {
            steps {
                script {
                    sh "aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}"
                    sh "docker push ${FULL_IMAGE_URI}"
                }
            }
        }

        stage('‚ò∏Ô∏è K8s Compliance (Kube-score)') {
            steps {
                sh "bash ci/scripts/scan_k8s_kubescore.sh"
            }
        }

        stage('üöÄ Deploy to EKS') {
            steps {
                script {
                    sh "aws eks update-kubeconfig --region ${AWS_REGION} --name ${EKS_CLUSTER_NAME}"
                    dir('helm/app') {
                        sh "helm upgrade --install ${IMAGE_NAME} . --set image.repository=${ECR_REGISTRY}/${IMAGE_NAME} --set image.tag=${IMAGE_TAG} --namespace default"
                    }
                }
            }
        }
    } // Fin des stages

    post {
        always {
            // 1. Archivage local
            archiveArtifacts artifacts: 'ci/reports/**/*', allowEmptyArchive: true
            
            // 2. Archivage distant S3
            script {
                try {
                    dir('infra/terraform') {
                        sh "terraform init -backend-config=\"bucket=s3-bucket-pfs-backup-tfstate-projets\"" 
                        env.BUCKET_NAME = sh(script: "terraform output -raw audit_reports_bucket_name", returnStdout: true).trim()
                    }
                    sh "bash ci/scripts/archive_reports.sh"
                } catch (Exception e) {
                    echo "‚ö†Ô∏è Archivage S3 ignor√© ou √©chou√© : ${e.message}"
                }
            }
        }
    }
}