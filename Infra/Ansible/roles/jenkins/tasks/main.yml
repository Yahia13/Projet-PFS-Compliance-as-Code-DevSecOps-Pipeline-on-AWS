---
- name: Ensure keyrings directory exists
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Download Jenkins keyring (ASCII)
  get_url:
    url: https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
    dest: /etc/apt/keyrings/jenkins-keyring.asc
    mode: "0644"

- name: Remove any old Jenkins repo entries (avoid Signed-By conflicts)
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/jenkins.list
    - /etc/apt/sources.list.d/jenkins.list.save
    - /etc/apt/sources.list.d/pkg.jenkins.io_debian-stable.list

- name: Install Java 17 (Ubuntu package)
  apt:
    name: openjdk-17-jre-headless
    state: present
    update_cache: yes

- name: Add Jenkins apt repo (with signed-by)
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/"
    state: present
    filename: jenkins
    update_cache: yes

- name: Installer Jenkins
  apt:
    name: jenkins
    state: present
    update_cache: yes

- name: Ensure Jenkins service is started and enabled
  service:
    name: jenkins
    state: started
    enabled: yes

- name: Ensure Jenkins plugins directory exists
  file:
    path: /var/lib/jenkins/plugins
    state: directory
    owner: jenkins
    group: jenkins
    mode: "0755"

- name: Télécharger Jenkins Plugin CLI
  get_url:
    url: https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/2.12.13/jenkins-plugin-manager-2.12.13.jar
    dest: /opt/jenkins-plugin-manager.jar
    mode: "0644"

- name: Copy Jenkins plugins list to Jenkins node
  copy:
    src: jenkins-plugins.txt
    dest: /tmp/jenkins-plugins.txt
    owner: jenkins
    group: jenkins
    mode: "0644"

- name: Install Jenkins plugins
  command: >
    java -jar /opt/jenkins-plugin-manager.jar
    --war /usr/share/java/jenkins.war
    --plugin-file /tmp/jenkins-plugins.txt
    --plugin-download-directory /var/lib/jenkins/plugins
  args:
    creates: /var/lib/jenkins/plugins/.plugins_installed
  notify: Redémarrer Jenkins

- name: Mark plugins installed (idempotency flag)
  file:
    path: /var/lib/jenkins/plugins/.plugins_installed
    state: touch
    owner: jenkins
    group: jenkins
    mode: "0644"

- name: Ensure plugins ownership is jenkins
  file:
    path: /var/lib/jenkins/plugins
    state: directory
    recurse: yes
    owner: jenkins
    group: jenkins

- name: Disable Jenkins setup wizard
  lineinfile:
    path: /etc/default/jenkins
    regexp: '^JAVA_ARGS='
    line: 'JAVA_ARGS="-Djenkins.install.runSetupWizard=false"'
    create: yes
  notify: Redémarrer Jenkins