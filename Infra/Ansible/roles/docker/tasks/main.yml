---
- name: Check Docker binary exists
  command: docker --version
  register: docker_check
  ignore_errors: true
  changed_when: false

- name: Check Docker service state
  command: systemctl is-active docker
  register: docker_active
  ignore_errors: true
  changed_when: false
  when: docker_check.rc == 0

# If docker exists but service is not active, try to heal it
- name: Reload systemd (safe)
  command: systemctl daemon-reload
  changed_when: false
  when:
    - docker_check.rc == 0
    - docker_active.rc != 0

- name: Restart containerd first (dependency)
  service:
    name: containerd
    state: restarted
  ignore_errors: true
  when:
    - docker_check.rc == 0
    - docker_active.rc != 0

- name: Restart docker with retries (do not fail immediately)
  service:
    name: docker
    state: restarted
    enabled: yes
  register: docker_restart
  retries: 8
  delay: 10
  until: docker_restart is succeeded
  ignore_errors: true
  when:
    - docker_check.rc == 0
    - docker_active.rc != 0

# Re-check after attempts
- name: Verify Docker is running
  command: systemctl is-active docker
  register: docker_final
  ignore_errors: true
  changed_when: false
  when: docker_check.rc == 0

- name: Show docker status if still failing (debug only)
  command: systemctl status docker --no-pager -l
  register: docker_status
  ignore_errors: true
  changed_when: false
  when:
    - docker_check.rc == 0
    - docker_final.rc != 0

- name: Print docker status output
  debug:
    var: docker_status.stdout_lines
  when:
    - docker_check.rc == 0
    - docker_final.rc != 0

# This prevents: "Group docker does not exist"
- name: Ensure docker group exists
  group:
    name: docker
    state: present

# Jenkins user docker group (safe even if docker temporarily down)
- name: Add jenkins user to docker group
  user:
    name: jenkins
    groups: docker
    append: yes
  ignore_errors: true

# Ensure docker socket perms so Jenkins can talk to Docker daemon
- name: Ensure docker socket permissions
  file:
    path: /var/run/docker.sock
    owner: root
    group: docker
    mode: "0660"
  ignore_errors: true
  when: docker_check.rc == 0
